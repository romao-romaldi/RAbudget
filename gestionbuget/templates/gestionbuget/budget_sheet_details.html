{% extends "gestionbuget/base.html" %}
{% load aggregations static %}

{% block content %}
<div class="w-auto h-auto" x-data="{
    budget_total:0,
    t:[],
    total_pourcentage_depense: 0,
    chart_spent: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    chart_income: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],

    add_budget(id,value) {
        let i = this.t.filter(item => item.id !== id)
        i.push({id:id, value:value})
        this.t = i
    },
    get budget_total_spent() {
        const total= this.t.reduce((acc, budget) => acc + budget.value, 0)
        this.total_pourcentage_depense = parseFloat((total / this.budget_total) * 100).toFixed(2);

        return total;
    },

   
    get chart_data() {
        return [this.chart_spent, this.chart_income];
    },
}"
>
    <div class="max-w-7xl mx-auto flex flex-col gap-3 py-8 px-3" >
        <div>
            <div class="flex items-center max-sm:flex-col gap-6 max-sm:gap-3 max-sm:items-start">
                <a class="border-b font-semibold" href="{% url 'gestionbudget:budget_sheet_list' %}"><--- 
                    <span class="max-sm:hidden"> retour </span>
                </a>
                <div>
                    <h1 class="text-xl max-md:text-base font-bold">{{ budget_sheet.title }}</h1>
                    <p class="text-base max-md:text-sm text-gray-500 font-extralight">Created on: {{ budget_sheet.date_created  }}</p>
                </div>
            </div>
        </div>
        <div class="flex max-sm:flex-col gap-5 min-lg:items-center md:justify-between mt-4">
            <div>
                <h3>Filtre</h3>
                <form action="{% url 'gestionbudget:budget_sheet_detail' budget_sheet.pid %}" method="get">
                    <input type="month" name="month_filter" value="{{filter}}"
                    class="border rounded-md p-2" placeholder="Filtrer par mois">
                    <button type="submit" class="px-4 py-2 bg-teal-700 text-white rounded-md">Filtrer</button>
                    
                    {% if filter %}
                        <a href="{% url 'gestionbudget:budget_sheet_detail' budget_sheet.pid %}" 
                        class="px-4 py-2 ms-7 border border-red-700 text-red-700 rounded-md">
                        <span class="max-sm:hidden inline-block">
                            Suprimer le filtre
                        </span>
                        <span class="md:hidden inline-block">X</span> 
                        </a>
                    {% endif %}
                </form>
            </div>

            {% include "gestionbuget/htmx/section/section_core.html" %}


        </div>

        <div class="p-3 bg-teal-50 rounded-md grid md:grid-cols-5">
            <div class="md:col-span-2 flex flex-col gap-4">
                <h2 class="text-md font-semibold w-full text-center">{{ Month_current|date:"F" }}</h2>

                <div class="grid grid-cols-2 gap-4">
                    
                    <div class="border rounded-md p-2 text-base ">
                        <h3 class="text-sm text-gray-700">Total Revenus</h3>
                        <p class="text-lg font-bold"><span x-text="budget_total"></span> {{budget_sheet.currency}}</p>
                    </div>
                    <div class="border rounded-md p-2 text-base">
                        <h3 class="text-sm text-gray-700">Total Dépenses</h3>
                        <p class="text-lg font-bold"><span x-text="budget_total_spent"></span> {{budget_sheet.currency}}</p>
                        <p :class="{'text-red-500': total_pourcentage_depense > 100, 'text-green-500': total_pourcentage_depense <= 100}"> <span x-text="total_pourcentage_depense"></span>% du révenue</p>
                    </div>

                </div>
                <!-- resumé sur chaque section  -->
                <div>
                    <div class="flex flex-col">
                        <div class="overflow-x-auto">
                            <div class="inline-block min-w-full border rounded-md">
                                <div class="overflow-hidden">
                                    <table class="min-w-full divide-y divide-neutral-200/70">
                                        <thead>
                                            <tr class="text-neutral-800">
                                                <th class="px-5 py-3 text-xs font-medium text-left uppercase">Source</th>
                                                <th class="px-5 py-3 text-xs font-medium text-left uppercase">Budget</th>
                                                <th class="px-5 py-3 text-xs font-medium text-left uppercase">Réel</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-neutral-200/70">
                                            {% for type_budget in type_budgets %}
                                                <tr class="text-neutral-600 bg-neutral-50">
                                                    <td class="px-5 py-4 text-sm font-medium whitespace-nowrap">{{ type_budget.name }}  </td>
                                                    <td class="px-5 py-4 text-sm whitespace-nowrap">
                                                        {% if type_budget.budgets.all.count %}
                                                        {{ type_budget.budgets.all|aggregate_sum:"amount_spent" }} {{ budget_sheet.currency }}
                                                        {% else %}
                                                            0 {{ budget_sheet.currency }}
                                                        {% endif %}
                                                    </td>
                                                    <td class="px-5 py-4 text-sm whitespace-nowrap">
                                                        {% if type_budget.budgets.all.count %}
                                                            {{ type_budget.budgets.all|aggregate_sum:"amount_reel" }} {{ budget_sheet.currency }}
                                                        {% else %}
                                                            0 {{ budget_sheet.currency }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="md:col-span-3 max-md:overflow-x-scroll">
                <div class="w-full h-96 max-md:overflow-x-scroll" id="chart"></div>
                <div

                x-data="{ modalOpenChart: false }"
                @keydown.escape.window="modalOpenChart = false" :class="{ 'z-40': modalOpenChart }">
                    <button @click="modalOpenChart=true">Voir les statistiques Annuel</button>

                    <template x-teleport="body">
                        <div x-show="modalOpenChart" class="fixed top-0 left-0 z-[99] flex items-center justify-center w-screen h-screen" x-cloak>
                            <div x-show="modalOpenChart"
                                x-transition:enter="ease-out duration-300"
                                x-transition:enter-start="opacity-0"
                                x-transition:enter-end="opacity-100"
                                x-transition:leave="ease-in duration-300"
                                x-transition:leave-start="opacity-100"
                                x-transition:leave-end="opacity-0"
                                @click="modalOpenChart=false" class="absolute inset-0 w-full h-full bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
                            <div x-show="modalOpenChart"
                                x-trap.inert.noscroll="modalOpenChart"
                                x-transition:enter="ease-out duration-300"
                                x-transition:enter-start="opacity-0 scale-90"
                                x-transition:enter-end="opacity-100 scale-100"
                                x-transition:leave="ease-in duration-200"
                                x-transition:leave-start="opacity-100 scale-100"
                                x-transition:leave-end="opacity-0 scale-90"
                                class="relative w-full py-6 bg-white shadow-md px-7 bg-opacity-90 drop-shadow-md backdrop-blur-sm sm:max-w-3xl sm:rounded-lg">
                                <div class="flex items-center justify-between pb-3">
                                    <h3 class="text-2xl font-semibold">Vos statistique de l'année </h3>
                                    <button @click="modalOpenChart=false" class="absolute top-0 right-0 flex items-center justify-center w-8 h-8 mt-5 mr-5 text-gray-600 rounded-full hover:text-gray-800 hover:bg-gray-50">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>  
                                    </button>
                                </div>
                                <div class="relative w-auto pb-8">
                                    <div id="chartYear"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mt-6">
            {% for type_budget in type_budgets %}
           <div x-data="{ modalOpen: false }" 
                @keydown.escape.window="modalOpen = false" :class="{ 'z-40': modalOpen }"
                class="border rounded-md p-3 bg-white shadow-sm  mb-8">
                <div class="flex items-center justify-between  pb-4 px-2">
                    <h2 class="text-lg font-semibold ">{{ type_budget.name }}</h2>
                    <div class="flex items-center ">
                        <button @click="modalOpen=true"
                        class="text-md rounded-full  px-3 py-1.5 shadow text-teal-500 hover:bg-teal-700">+</button>
                    </div>
                </div>
                <div class=" overflow-x-auto " id="tbody_budget_{{type_budget.name}}">
                    <table class="min-w-full divide-y divide-neutral-200/70 overflow-y-hidden">
                        <thead>
                            <tr class="text-neutral-800">
                                <th class="px-5 py-3 text-xs font-medium text-left uppercase">
                                    {% if type_budget.is_income %}
                                    Source
                                    {% else %}
                                      Nom
                                    {% endif %}
                                </th>
                                <th class="px-5 py-3 text-xs font-medium text-left uppercase">
                                    {% if type_budget.is_income %}
                                        Attendu
                                    {% else %}
                                        Budget Attendu
                                    {% endif %}
                                </th>
                                <th class="px-5 py-3 text-xs font-medium text-left uppercase">Date d'échéance</th>
                                <th class="px-5 py-3 text-xs font-medium text-left uppercase">Réel</th>
                                {% if not type_budget.is_income %}
                                    <th class="px-5 py-3 text-xs font-medium text-left uppercase">Difference</th>
                                {% endif %}
                                {% if type_budget.is_compte %}
                                    <th class="px-5 py-3 text-xs font-medium text-left uppercase">Compte</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-neutral-200/70" >
                            {% for budget in type_budget.budgets.all %}
                            <tr class="text-neutral-600 bg-neutral-50">
                                <td class="px-5 py-4 text-sm font-medium whitespace-wrap">{{ budget.title }}</td>
                                <td class="px-5 py-4 text-sm whitespace-nowrap">{{ budget.amount_spent }}</td>
                                <td class="px-5 py-4 text-sm whitespace-nowrap">{{ budget.due_date }}</td>
                                <td class="px-5 py-4 text-sm whitespace-nowrap">{{ budget.amount_reel }} </td>
                                {% if not type_budget.is_income %}
                                    <th class="px-5 py-3 text-xs font-medium text-left uppercase">
                                        {{budget|aggregate_difference}}
                                    </th>
                                {% endif %}
                                {% if type_budget.is_compte %}
                                    <th class="px-5 py-3 text-xs font-medium text-left uppercase">{{budget.account}}</th>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot  >
                            <tr class="text-neutral-800" id="tfoot_budget_{{type_budget.name}}">
                                <td class="px-5 py-3 text-sm font-medium whitespace-nowrap">Total</td>
                                <td class="px-5 py-3 text-sm font-medium whitespace-nowrap">
                                    {% if type_budget.budgets.all.count %}
                                        {{ type_budget.budgets.all|aggregate_sum:"amount_spent" }} {{ budget_sheet.currency }}
                                    {% else %}
                                        0 {{ budget_sheet.currency }}
                                    {% endif %}
                                </td>
                                <td class="px-5 py-3 text-sm font-medium whitespace-nowrap"></td>
                               
                                <td class="px-5 py-3 text-sm font-medium whitespace-nowrap">
                                    {% if type_budget.budgets.all.count %}
                                        {{ type_budget.budgets.all|aggregate_sum:"amount_reel" }} {{ budget_sheet.currency }}

                                        {% if type_budget.is_income %}
                                            <span x-data="" x-init="budget_total={{ type_budget.budgets.all|aggregate_sum:'amount_reel' }}">
                                            </span>
                                        {% elif type_budget.is_spent %}
                                            <span x-data="" 
                                            x-init="add_budget({{type_budget.id}},{{ type_budget.budgets.all|aggregate_sum:'amount_reel'}})">
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        0 {{ budget_sheet.currency }}
                                    {% endif %}
                                </td>
                                {% if not type_budget.is_income %}
                                <td class="px-5 py-3 text-sm font-medium whitespace-nowrap">
                                   {% if type_budget.budgets.all.count %}
                                        {{ type_budget.budgets.all|aggregate_differnces }} {{ budget_sheet.currency }}
                                    {% else %}
                                        0 {{ budget_sheet.currency }}
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <template x-teleport="body">
                    <div x-show="modalOpen" class="fixed top-0 left-0 z-[99] flex items-center justify-center w-screen h-screen" x-cloak>
                        <div x-show="modalOpen"
                            x-transition:enter="ease-out duration-300"
                            x-transition:enter-start="opacity-0"
                            x-transition:enter-end="opacity-100"
                            x-transition:leave="ease-in duration-300"
                            x-transition:leave-start="opacity-100"
                            x-transition:leave-end="opacity-0"
                            @click="modalOpen=false" class="absolute inset-0 w-full h-full bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
                        <div x-show="modalOpen"
                            x-trap.inert.noscroll="modalOpen"
                            x-transition:enter="ease-out duration-300"
                            x-transition:enter-start="opacity-0 scale-90"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="ease-in duration-200"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-90"
                            class="relative w-full py-6 bg-white shadow-md px-7 bg-opacity-90 drop-shadow-md backdrop-blur-sm sm:max-w-lg sm:rounded-lg">
                            <div class="flex items-center justify-between pb-3">
                                <h3 class="text-lg font-semibold">Ajouté un(e) {{ type_budget.name }}</h3>
                                <button @click="modalOpen=false" class="absolute top-0 right-0 flex items-center justify-center w-8 h-8 mt-5 mr-5 text-gray-600 rounded-full hover:text-gray-800 hover:bg-gray-50">
                                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>  
                                </button>
                            </div>
                            <div class="relative w-auto pb-8">
                                {% include "gestionbuget/htmx/create_budgets.html" %}
                            </div>
                        </div>
                    </div>
                </template>

            </div>
            {% endfor %}

           </div>


        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="{% static 'js/apexchart.min.js' %}"></script>

<script>
    function handleAddBudget(event) {
        this.responseStatus = event.detail.xhr.status;
        if (this.responseStatus === 201){
            this.modalOpen = false;
            this.title = "Success";
            this.description = "Le budget a été créée avec succès.";
            this.type = "success";
            this.popToast();
            // this.$dispatch('htmx:after-request', { successful: true });
        }
        else {
            this.title = "Erreur";
            this.description = "Une erreur s'est produite lors de la création du budget.";
            this.type = "Danger";
            this.popToast();
        }

    }
    x_data_default = ["jan", "fev", "mars", "avr", "mai", "juin","juil", "aout", "sept", "oct", "nov","déc"]

    function the_options (
        spent = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        income = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        x_data = x_data_default,
        idChart="#chart",
        
    ) {

        let options = {
            series: [
                {
                name: 'Dépenses',
                colors:"#3BC77",
                data: spent // Example data
                },
                {
                name: 'Revenus',
                colors:"#3BB77E",
                data: income // Example data
                }
            ],
        
            chart: {
                height: 350,
                type: 'line',            
                zoom: {
                    enabled: false,

                },
                scrollX : true
                
            },
            stroke: {
            curve: 'smooth'
            },
            markers: {
                size: 4,
            },
            // fill: {
            //     colors: '#3BB77E'
            // },
            grid: {
            row: {
                colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
                opacity: 0.5
            },
            },
            
            xaxis: {
                categories: x_data
            }
        }
        let chart = new ApexCharts(document.querySelector(idChart), options);
        chart.render();

        return chart;
    }

    chart = the_options()

    async function recuper_chart() {
        data = fetch(`{% url 'gestionbudget:chart_budget' budget_sheet.pid %}`)
        .then(response => response.json())
        .then(data => {
            return data
        })
        the_data = await data;
        if (the_data) {
            chart.destroy();
            the_options(the_data.spent,the_data.icome, x_data_default, "#chartYear");
        }
    }

    async function recuper_chart_month() {
        data = fetch(`{% url 'gestionbudget:chart_budget_month' budget_sheet.pid %}?month_filter={{filter}}`)
        .then(response => response.json())
        .then(data => {
            return data
        })
        the_data = await data;
        if (the_data) {
            chart.destroy();
            the_options(the_data.spent,the_data.income, the_data.x_data);
        }
    }

    recuper_chart();
    recuper_chart_month()



</script>
{% endblock js %}